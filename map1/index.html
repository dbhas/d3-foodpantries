<!DOCTYPE html>
<html>
<head>
	<title>Map 1</title>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>
	<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>



	<style type="text/css">
		#map {
			width: 600px;
		}
		path {
			stroke: #000;
		}
	</style>
</head>
<body>

<div id="map" class="map"></div>

<script type="text/javascript">



var cities = [
  {
    name: "Downtown",
    location: {
      latitude: 34.042001,
      longitude: -118.245578
    }
  }, 
  {
    name: "San Pedro",
    location: {
      latitude: 33.7395016,
      longitude: -118.28357
    }
  },
  {
    name: "Northridge",
    location: {
        latitude: 34.2391395,
        longitude: -118.5238183
    }
  },
  {
    name: "Brentwood",
    location: {
        latitude: 34.0648156,
        longitude: -118.4853923
    }
  }
];

function bulkText(d){
    return d >=0.4 ? "#fff" : '#333' ;
}
function potholeText(d){
    return d >=20 ? "#fff" : '#333' ;
}
function graffitiText(d){
    return d >=1 ? "#fff" : '#333' ;
}

        
var windowWidth = document.documentElement.clientWidth;

var div = d3.select('body').append('div')
            .attr('class','tooltip')
            .style('opacity', "0");

if (windowWidth < 600){
    $(div).remove();
}
var mouseX, mouseY;
// var width  = 360;
// var height = 600;
var width = parseInt(d3.select('.map').style('width')),
  width = (width),
   mapRatio = 1.65,
   height = width * mapRatio;

var color_domain = [0, 5, 10, 15, 20, 25, 30];
var bulky_domain = [0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6];
var graffiti_domain = [0, 1, 2, 3];
var color = d3.scale.threshold().domain(color_domain)
.range(['#e0ecf4',"#ffffd9","#f7fcb9","#addd8e","#41ab5d","#238443","#004529"]);

var bulkyColor = d3.scale.threshold().domain(bulky_domain)
.range(['#fee8c8','#fee8c8',"#fdd49e","#fdbb84","#fc8d59","#ef6548","#d7301f","#8B0000"]);

var graffitiColor = d3.scale.threshold().domain(graffiti_domain)
  .range(['#ccc','#a6bddb','#3690c0',"#02818a","#014636"]);
  // var vis = d3.select("#vis").append("svg")
  //     .attr("width", width).attr("height", height)
var svg = d3.select('#map').append("svg")
    .attr("width", width)
          .attr("height", height)
          .attr("class","potholesvg");
             g = svg.append("g");
             p = svg.append("path");

var projection = d3.geo.mercator()
            .scale(width*105)
            .center([-118.4, 34.02])
            // .center([131000000,3900000])
            .translate([width/2, height/2]);
var path = d3.geo.path().projection(projection);

path = d3.geo.path().projection(projection);
d3.select(window).on('resize', resize);

function resize() {
    // adjust things when the window size changes
            width = parseInt(d3.select('.map').style('width'));
            // width = width - margin.left - margin.right;
            height = width * mapRatio;

            // update projection
            projection
                .translate([width / 2, height / 2])
                .scale(width*105);

            // resize the map container
            d3.selectAll("svg")
                .style('width', width + 'px')
                .style('height', height + 'px');

            // resize the map
            d3.selectAll('svg').selectAll('g').attr('d', path);
            d3.selectAll('svg').selectAll('path').attr('d', path);
            $('.city-label').css('display','none');
            $('.circle').css('display','none');
            // d3.selectAll('svg').selectAll('circle').attr('d', path);
            // d3.selectAll('svg').selectAll('text').attr('d', path);
            // map.selectAll('.state').attr('d', path);
            }

d3.json("http://latimes-graphics-media.s3.amazonaws.com/interactives/city-services/all-categories.json", function(json) {
    $(window).mousemove( function(e) {
                mouseY = e.pageY;
                mouseX = (e.pageX < 125) ? 125 : (e.pageX > windowWidth-150) ? windowWidth-150 : e.pageX;
                    d3.select(".tooltip").style("top",(mouseY+20)+"px").style("left",(mouseX-125)+"px");
                
        });  
    
    //add city labels to first map
    svg.selectAll(".city-label")
        .data(cities)
        .enter().append("text")
        .attr("class","city-label")
        .attr("transform", function(d) {
        return "translate(" + projection([
          (d.location.longitude + 0.01),
          d.location.latitude
        ]) + ")";
        })
        .attr("dy", ".35em")
        .attr("font-size","13px")
        .attr("font-family","sans-serif")
        .text(function(d) { return d.name; });
    //add points to all maps
    (svg).selectAll(".pin")
      .data(cities)
      .enter().append("circle", ".pin")
      .attr("r", 5)
      .attr("fill","black")
      .attr("class","circle")
      .attr("transform", function(d) {
        return "translate(" + projection([
          (d.location.longitude),
          d.location.latitude
        ]) + ")";
      })
      .style("stroke-width", "1")
      .style("stroke", "#fff"); 
  g.selectAll("path").data(json.features).enter().append("path")
        .attr("d", path)
        .style("fill", function (d){
            return color(d.properties.pothole_ho);
        })
        .style("stroke-width", "1")
        .style("stroke", "#a2a2a2")
        .on("mouseover", function (d){
            d3.select(this).transition().duration(300).style("cursor","pointer").style("opacity",0.5);
            div.transition().duration(100).style("opacity", 0.9);
            div.html("<p>The median wait time for a pothole to be fixed in <strong>"+d.properties.ShapeName+"</strong> is <span style='border-bottom: 3px solid "+color(d.properties.pothole_ho)+"'>"+d.properties.pothole_ho+ " days.</p>")
            
        }).on("mouseout", function (d){
            d3.select(this).transition().duration(300).style("cursor","pointer").style("opacity",1);
            div.transition().duration(100)
                 .style("opacity", 0);
        });


    

    });

</script>

</body>
</html>